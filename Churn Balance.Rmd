---
title: "Churn Balance"
author: "Dominique Miranda"
output: html_document
---
output: 
  html_document:
    number_sections: yes
    toc: yes
    fig_width: 15
    fig_height: 10
---
#1 Set up, import data, and inspect the code 
#A) Load packages using library() and import data using read.csv(). Load factors as character strings first. Take a look at the overall structure of the input data.


```{r}
library(C50)
library(scatterplot3d)
library(caret)
library(rminer)
library(rmarkdown)
library(psych)
```

```{r}
setwd("~/IS 6842")
churn <- read.csv(file = "churn_balanced.csv", stringsAsFactors = FALSE)

str(churn)
summary(churn)
```

#B)Transform all string variables that include categorical values to factor variables. After this transformation, show the overall structure and summary of the input data
```{r}
churn$REPORTED_SATISFACTION <- factor(churn$REPORTED_SATISFACTION)
churn$CONSIDERING_CHANGE_OF_PLAN <- factor(churn$CONSIDERING_CHANGE_OF_PLAN)
churn$REPORTED_USAGE_LEVEL <- factor(churn$REPORTED_USAGE_LEVEL)
churn$COLLEGE <- factor(churn$COLLEGE)
churn$LEAVE <- factor(churn$LEAVE)

str(churn)
summary(churn)
```

# Code chunk 2: Explore the following numeric variables: INCOME, OVERAGE, and for each of these variables,
#A) Create a histogram and include a title of the histogram.
```{r}
hist(churn$INCOME, main = "Histogram of Income in the churn data set", xlab = "LEAVE")
hist(churn$OVERAGE, main = "Histogram of Overage in the churn data set", xlab = "LEAVE")
```

#B) Create a boxplot and include a title in the plot.
```{r}
boxplot(INCOME~LEAVE, data = churn, main = "Boxplot of Income in the churn data set")
boxplot(OVERAGE~LEAVE, data = churn, main = "Boxplot of Overage in the churn data set")
```

#C) Show deciles of the variable (i.e., deciles are basically quantiles using 0%, 10%, 20%, …, 90%, 100%).
```{r}
quantile(churn$INCOME, seq(from = 0, to = 1, by = 0.20))
quantile(churn$OVERAGE, seq(from = 0, to = 1, by = 0.10))
```

# Code chunk 3: Explore factor variables
#A) For each of the factor variables in the dataset, and for each of this variable’s levels (e.g., “LEAVE” and “STAY” of LEAVE), show the count value and percentage value of instances that belong to that level.

```{r}
levels(churn$LEAVE)
?levels

table(churn$LEAVE)
sort(table(churn$LEAVE), decreasing = TRUE)
?sort
```


```{r}
levels(churn$REPORTED_SATISFACTION)
?levels

table(churn$REPORTED_SATISFACTION)
sort(table(churn$REPORTED_SATISFACTION), decreasing = TRUE)
?sort
```

```{r}
levels(churn$CONSIDERING_CHANGE_OF_PLAN)
?levels

table(churn$CONSIDERING_CHANGE_OF_PLAN)
sort(table(churn$CONSIDERING_CHANGE_OF_PLAN), decreasing = TRUE)
?sort
```

```{r}
levels(churn$REPORTED_USAGE_LEVEL)
?levels

table(churn$REPORTED_USAGE_LEVEL)
sort(table(churn$REPORTED_USAGE_LEVEL), decreasing = TRUE)
?sort
```

```{r}
levels(churn$COLLEGE)
?levels

table(churn$COLLEGE)
sort(table(churn$COLLEGE), decreasing = TRUE)
?sort

```

#B) For each of the two-factor variables LEAVE and REPORTED_SATISFACTION, show a bar plot of the number of instances (i.e., count) of each categorical value. The bars should be arranged in descending order of instance count. Show a descriptive title in each plot (any appropriate title will do).
```{r}
churnleave.table <- table(churn$LEAVE)
churnleave.table
str(churnleave.table)

churnrep.table <- table(churn$REPORTED_SATISFACTION)
churnrep.table
str(churnrep.table)

barplot(churnleave.table, main = "Plot of Leave in the titanic data set", xlab = "LEAVE")
barplot(churnrep.table, main = "Plot of Reported Satisfaction in the titanic data set", xlab = "REPORTED_SATISFACTION")
```

# Code chunk 4: Explore relationships amongst multiple variables
#A) Use cor to display correlations among all of the numeric variables in the data set
```{r}
cov(churn[,c(5,6)])
var(churn[,c(5,6)])
var(churn[,5])
sd(churn[,5])
var(churn[5])
cor(churn[c("HOUSE", "OVER_15MINS_CALLS_PER_MONTH", "INCOME", "OVERAGE","LEFTOVER", "HANDSET_PRICE", "AVERAGE_CALL_DURATION")])
cor(churn[5:6])
cor(churn[,5:6])

cor(churn[4:7])
```

#B) Use panels to display histograms/scatter plots and correlations based on all of the numeric variables and the target variable in the data set
```{r}
pairs(churn[4:7])

pairs.panels(churn[-1])
pairs.panels(churn)
```

# Code chunk 5: For each of the numeric variables INCOME, OVERAGE, and LEFTOVER,
#A) Show a boxplot of this numeric variable by the target variable (i.e., for “LEAVE” and “STAY” separately).
```{r}
boxplot(INCOME~LEAVE, data = churn)
boxplot(OVERAGE~LEAVE, data = churn)
boxplot(LEFTOVER~LEAVE, data = churn)
```

#B) Use the aggregate function along with the “summary” function to aggregate this variable by the target variable. The output should be the six number statistics (i.e., min., 1st quartile, median, mean, 3rd quartile, and max.) of the variable (e.g., INCOME) aggregated by “LEAVE” and “STAY” respectively.
```{r}
aggregate(OVERAGE~LEAVE, summary, data = churn)
aggregate(INCOME~LEAVE, summary, data = churn)
aggregate(LEFTOVER~LEAVE, summary, data = churn)
```

# Code chunk 6: Data preparation
#A) Partition the imported data set for a simple hold-out evaluation: 70% for training and the other 30% for testing. Show the summary of training and test sets.
```{r}
set.seed(100)
inTrain <- createDataPartition(churn$LEAVE, p=0.5, list=FALSE)
str(inTrain)

churnTrain <- churn[inTrain,]
churnTest <- churn[-inTrain,]

summary(churnTrain)
summary(churnTest)

```

#B) Show the proportions of “LEAVE” and “STAY” of the target variable in the training set and in the test set, separately.
```{r}
table(churnTrain$LEAVE)
prop.table(table(churnTrain$LEAVE))

table(churnTest$Survived)
prop.table(table(churnTest$Survived))
```

# Code chunk 7: Train and Test “Decision Tree 1”
#A) Train a C5.0 model with the default setting to classify the target variable (i.e., LEAVE) using all other variables as predictors. Show this model to find out the size of the tree. Since the model is very complex now, do not show the summary of the model, and do not plot the tree at this point.
```{r}
churn_m1_c50 <- C5.0(LEAVE~., churnTrain)
churn_m1_c50
```

#B) Using the predict() and mmetric() functions, generate and compare this model’s confusion matrices and other evaluation metrics in the test and training sets.
```{r}
predicted_LEAVE_test1 <- predict(churn_m1_c50, churnTest)
mmetric(churnTest$LEAVE, predicted_LEAVE_test1, metric="CONF")
mmetric(churnTest$LEAVE, predicted_LEAVE_test1, metric=c("ACC","TPR","PRECISION","F1"))

predicted_LEAVE_train1 <- predict(churn_m1_c50, churnTrain)
mmetric(churnTrain$LEAVE, predicted_LEAVE_train1, metric="CONF")
mmetric(churnTrain$LEAVE, predicted_LEAVE_train1, metric=c("ACC","TPR","PRECISION","F1"))
```

# Code chunk 8: Train and Test “Decision Tree 2”
#A) Build a simplified, plottable version of Decision Tree 1 by adjusting the confidence factor (CF) of Decision Tree 1. Show this model to find out the size of the tree and also show the summary of the model. Plot the tree since it is simpler. Try to adjust the CF value to come up with a tree that is simple enough to be plotted.
```{r}
churn_dt2_c50 <- C5.0(churnTrain[-1], churnTrain$LEAVE, control = C5.0Control(CF = 0.3))
churn_dt2_c50

#plot(churn_dt2_c50)
summary(churn_dt2_c50)
```

#B) Using the predict() and mmetric() functions, generate and compare this model’s confusion matrices and other evaluation metrics in the test and training sets.
```{r}
predicted_LEAVE_test2 <- predict(churn_dt2_c50, churnTest)
mmetric(churnTest$LEAVE, predicted_LEAVE_test2, metric="CONF")
mmetric(churnTest$LEAVE, predicted_LEAVE_test2, metric=c("ACC","TPR","PRECISION","F1"))

predicted_LEAVE_train2 <- predict(churn_dt2_c50, churnTrain)
mmetric(churnTrain$LEAVE, predicted_LEAVE_train2, metric="CONF")
mmetric(churnTrain$LEAVE, predicted_LEAVE_train2, metric=c("ACC","TPR","PRECISION","F1"))
```

# Code chunk 9: Train and Test “Decision Tree 3”
#A) Remove INCOME as a predictor for Decision Tree 3. Train a C5.0 model with the default setting to classify the target variable (i.e., LEAVE) using all other remaining variables as predictors. Show this model to find out the size of the tree.
```{r}
churn_w3_c50 <- C5.0(churn[c(-2)],churn$LEAVE)
churn_w3_c50

#plot(churn_w3_c50)
summary(churn_w3_c50)

```

#B) Using the predict() and mmetric() functions, generate and compare this model’s confusion matrices and other evaluation metrics in the test and training sets.
```{r}
predicted_LEAVE_test3 <- predict(churn_w3_c50, churnTest)
mmetric(churnTest$LEAVE, predicted_LEAVE_test3, metric="CONF")
mmetric(churnTest$LEAVE, predicted_LEAVE_test3, metric=c("ACC","TPR","PRECISION","F1"))

predicted_LEAVE_train3 <- predict(churn_w3_c50, churnTrain)
mmetric(churnTrain$LEAVE, predicted_LEAVE_train3, metric="CONF")
mmetric(churnTrain$LEAVE, predicted_LEAVE_train3, metric=c("ACC","TPR","PRECISION","F1"))
```

# Code chunk 10: Train and Test “Decision Tree 4”
#A) Build a simplified, plottable version of Decision Tree 3 by adjusting the confidence factor (CF) of Decision Tree 3. Show this model to find out the size of the tree and also show the summary of the model. Plot the tree.
```{r}
churn_m4_c50 <- C5.0(churnTrain[-1], churnTrain$LEAVE, control = C5.0Control(CF = 0.8))

#plot(churn_m4_c50, pch = as.numeric(churnTrain$LEAVE))
summary(churn_m4_c50)
```

#B) Using the predict() and mmetric() functions, generate and compare this model’s confusion matrices and other evaluation metrics in the test and training sets.
```{r}
predicted_LEAVE_test4 <- predict(churn_m4_c50, churnTest)
mmetric(churnTest$LEAVE, predicted_LEAVE_test4, metric="CONF")
mmetric(churnTest$LEAVE, predicted_LEAVE_test4, metric=c("ACC","TPR","PRECISION","F1"))

predicted_LEAVE_train4 <- predict(churn_m4_c50, churnTrain)
mmetric(churnTrain$LEAVE, predicted_LEAVE_train4, metric="CONF")
mmetric(churnTrain$LEAVE, predicted_LEAVE_train4, metric=c("ACC","TPR","PRECISION","F1"))
```

